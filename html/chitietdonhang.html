<!DOCTYPE html>
<html ng-app="myApp">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thông Tin Đơn Hàng</title>
    <link rel="shortcut icon" type="image/png" href="../assets/images/logos/runflex.jpg" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/css/bootstrap.min.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <link rel="stylesheet" href="../assets/libs/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/angular-utils-pagination@0.11.1/dirPagination.js"></script>
    <link rel="stylesheet" href="../assets/css/styles.min.css" />
    <link rel="stylesheet" href="../assets/css/main.css" />


    <script src="../assets/js/chitietdonhang.js"></script>
    <script src="../assets/js/main.js"></script>

    <style>
        button.btn-sm {
            font-size: 0.875rem;
            /* Giảm kích thước chữ */
            border-radius: 4px;
            /* Tạo góc bo nhỏ hơn */
        }

        .step-icon {
            font-size: 36px;
            /* Tăng kích thước icon */
        }

        .step p {
            font-size: 16px;
            /* Tăng kích thước chữ */
        }

        .line {
            height: 3px;
            /* Tăng độ dày của đường nối */
            width: 50px;
            /* Đặt chiều dài của đường nối */
            background-color: #ccc;
            /* Màu đường nối */
            margin-top: 15px;
        }

        .line-done {
            background-color: #28a745;
            /* Màu đường nối đã hoàn thành */
        }
    </style>
</head>

<body ng-controller="chiTietDonHangController">
    <div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
        data-sidebar-position="fixed" data-header-position="fixed">
        <!-- Sidebar -->
        <div ng-include="'../Layout/Sidebar.html'"></div>

        <!-- Body Wrapper -->
        <div class="body-wrapper">
            <div ng-include="'../Layout/Header.html'"></div>

            <!-- Main Content -->
            <div class="container-fluid">
                <!-- Order Status Steps -->
                <div class="container mt-5">
                    <h4>Trạng Thái Đơn Hàng</h4>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <!-- Step 1: Tạo đơn hàng -->
                                <div class="step text-center" ng-if="invoice.status >= 0">
                                    <span class="step-icon" ng-class="{'step-done': invoice.status >= 0}">
                                        <iconify-icon icon="mdi:clipboard-edit-outline" width="36"
                                            height="36"></iconify-icon>
                                    </span>
                                    <p>Tạo đơn hàng</p>
                                    <small>{{ invoice.ngayTao | date: 'HH:mm:ss dd/MM/yyyy' }}</small>
                                </div>

                                <div class="line" ng-class="{'line-done': invoice.status >= 1}"></div>

                                <!-- Step 2: Chờ Xác Nhận -->
                                <div class="step text-center" ng-if="invoice.status >= 1">
                                    <span class="step-icon" ng-class="{'step-done': invoice.status >= 1}">
                                        <iconify-icon icon="mdi:timer-sand" width="36" height="36"></iconify-icon>
                                    </span>
                                    <p>Chờ Xác Nhận</p>
                                    <small>{{ invoice.ngayChoXacNhan | date: 'HH:mm:ss dd/MM/yyyy' }}</small>
                                </div>

                                <div class="line" ng-class="{'line-done': invoice.status >= 2}"></div>

                                <!-- Step 3: Chờ giao -->
                                <div class="step text-center" ng-if="invoice.status >= 2">
                                    <span class="step-icon" ng-class="{'step-done': invoice.status >= 2}">
                                        <iconify-icon icon="mdi:truck-fast" width="36" height="36"></iconify-icon>
                                    </span>
                                    <p>Chờ giao</p>
                                    <small>{{ invoice.ngayChoGiao | date: 'HH:mm:ss dd/MM/yyyy' }}</small>
                                </div>

                                <div class="line" ng-class="{'line-done': invoice.status >= 3}"></div>

                                <!-- Step 4: Đang giao -->
                                <div class="step text-center" ng-if="invoice.status >= 3">
                                    <span class="step-icon" ng-class="{'step-done': invoice.status >= 3}">
                                        <iconify-icon icon="mdi:truck" width="36" height="36"></iconify-icon>
                                    </span>
                                    <p>Đang giao</p>
                                    <small>{{ invoice.ngayDangGiao | date: 'HH:mm:ss dd/MM/yyyy' }}</small>
                                </div>

                                <div class="line" ng-class="{'line-done': invoice.status >= 4}"></div>

                                <!-- Step 5: Hoàn thành -->
                                <div class="step text-center" ng-if="invoice.status >= 4">
                                    <span class="step-icon" ng-class="{'step-done': invoice.status >= 4}">
                                        <iconify-icon icon="mdi:check-circle-outline" width="36"
                                            height="36"></iconify-icon>
                                    </span>
                                    <p>Hoàn thành</p>
                                    <small>{{ invoice.ngayHoanThanh | date: 'HH:mm:ss dd/MM/yyyy' }}</small>
                                </div>

                                <div class="line" ng-class="{'line-done': invoice.status >= 5}"></div>

                                <!-- Step 6: Hủy -->
                                <div class="step text-center" ng-if="invoice.status >= 5">
                                    <span class="step-icon" ng-class="{'step-done': invoice.status >= 5}">
                                        <iconify-icon icon="mdi:cancel" width="36" height="36"></iconify-icon>
                                    </span>
                                    <p>Hủy</p>
                                    <small>{{ invoice.ngayHuy | date: 'HH:mm:ss dd/MM/yyyy' }}</small>
                                </div>

                                <div class="line" ng-class="{'line-done': invoice.status >= 6}"></div>

                                <!-- Step 7: Chờ thanh toán -->
                                <div class="step text-center" ng-if="invoice.status >= 6">
                                    <span class="step-icon" ng-class="{'step-done': invoice.status >= 6}">
                                        <iconify-icon icon="mdi:credit-card-outline" width="36"
                                            height="36"></iconify-icon>
                                    </span>
                                    <p>Chờ thanh toán</p>
                                    <small>{{ invoice.ngayThanhToan | date: 'HH:mm:ss dd/MM/yyyy' }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>




            <div class="container mt-4">
                <h4 class="mb-4">Chuyển Trạng Thái Đơn Hàng</h4>
                <div class="card p-4 shadow-sm">
                    <p><strong>Trạng Thái Hiện Tại:</strong> {{ getStatus(invoice.status) }}</p>

                    <!-- Bố trí 2 nút cùng 1 hàng, mỗi nút có màu sắc khác nhau và thêm biểu tượng -->
                    <div class="d-flex gap-2">

                        <button class="btn btn-success btn-sm px-4 py-2" ng-click="updateStatus(invoice)"
                            ng-disabled="invoice.status >= 4">
                            <!-- Thêm icon từ Iconify, sử dụng đúng mã -->
                            <iconify-icon icon="twemoji:pencil" width="16" height="16"
                                style="vertical-align: middle; margin-right: 5px;"></iconify-icon> Chuyển trạng thái
                        </button>
                        <!-- Kiểm tra trạng thái là "Chờ xác nhận" (Trạng thái 1) -->
                        <div ng-if="invoice.status === 1">
                            <button class="btn btn-primary btn-sm px-4 py-2" ng-click="printInvoice()">
                                <!-- Thêm icon từ Iconify -->
                                <iconify-icon icon="twemoji:printer" width="16" height="16"
                                    style="vertical-align: middle; margin-right: 5px;"></iconify-icon> In hóa đơn
                            </button>
                            <button class="btn btn-danger btn-sm px-4 py-2" ng-click="cancelInvoice(invoice)">
                                <iconify-icon icon="twemoji:cross-mark" width="16" height="16"
                                    style="vertical-align: middle; margin-right: 5px;"></iconify-icon> Hủy đơn
                            </button>
                        </div>
                    </div>
                </div>
            </div>


            <!-- moldal sửa thông tin đơn hàng -->
            <div class="modal fade" id="editInvoiceModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Sửa Thông Tin Đơn Hàng</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form>
                                <div class="mb-3">
                                    <label for="consigneeName" class="form-label">Tên Người Nhận</label>
                                    <input type="text" class="form-control" id="consigneeName"
                                        ng-model="invoice.consigneeName">
                                </div>
                                <div class="mb-3">
                                    <label for="deliveryAddress" class="form-label">Địa Chỉ</label>
                                    <input type="text" class="form-control" id="deliveryAddress"
                                        ng-model="invoice.deliveryAddress">
                                </div>
                                <div class="mb-3">
                                    <label for="phoneNumber" class="form-label">Số Điện Thoại</label>
                                    <input type="text" class="form-control" id="phoneNumber"
                                        ng-model="invoice.phoneNumber">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                            <button type="button" class="btn btn-primary" ng-click="updateInvoice()">Lưu Thay
                                Đổi</button>
                        </div>
                    </div>
                </div>
            </div>



            <!-- Back Button -->
            <div class="col-md-4 d-flex align-items-center">
                <a class="btn btn-secondary mt-3" ng-href="donhang.html">Quay Lại</a>
            </div>

            <!-- Invoice Details -->
            <div class="container mt-4">
                <h4 class="mb-4 text-center">Thông Tin Đơn Hàng</h4>

                <button class="btn btn-primary mb-3" ng-click="openEditInvoiceModal()"
                    ng-if="invoice.status === 1 || invoice.status === 2">
                    Sửa Đơn Hàng
                </button>

                <!-- Card hiển thị thông tin đơn hàng -->
                <div ng-if="invoice" class="card p-4 shadow-sm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Trạng Thái:</strong> <span class="badge bg-info text-dark">{{
                                    getStatus(invoice.status) }}</span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Tiền Phải Trả:</strong>
                                <span class="text-success fw-bold">{{ calculateAmountToPay(invoicedetail) | currency
                                    }}</span>
                            </p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Mã Hóa Đơn:</strong> <span>{{ invoice.invoiceCode }}</span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Ngày Đặt Hàng:</strong> <span>{{ invoice.createdDate | date: 'dd/MM/yyyy'
                                    }}</span></p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Tên Người Nhận:</strong> <span>{{ invoice.consigneeName }}</span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Địa Chỉ:</strong> <span>{{ invoice.deliveryAddress }}</span></p>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Số Điện Thoại:</strong> <span>{{ invoice.phoneNumber }}</span></p>
                        </div>
                    </div>
                </div>

                <!-- Thông báo nếu không tìm thấy thông tin đơn hàng -->
                <div ng-if="!invoice" class="alert alert-danger text-center">
                    Không tìm thấy thông tin đơn hàng!
                </div>
            </div>

            <!-- <h4 class="mb-4">Lịch Sử Thanh Toán</h4>
            <div class="table-responsive mt-4">
                <table class="table table-bordered table-hover table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Số tiền</th>
                            <th>Thời gian</th>
                            <th>Phương thức thanh toán</th>
                            <th>Nhân viên xác nhận</th>
                            <th>Ghi chú</th>
                        </tr>
                    </thead>
                    <tbody> -->
            <!-- Nội dung bảng sẽ được chèn vào đây -->
            <!-- </tbody>
                </table>
            </div> -->

            <!-- Nút Xác nhận thanh toán -->
            <!-- <div class="d-flex justify-content-end mt-3">
                <button class="btn btn-success">Xác nhận thanh toán</button>
            </div> -->


            <h4 class="mb-4">Thông Tin Sản Phẩm</h4>
            <button class="btn btn-success mb-3" ng-click="openAddProductModal()"
                ng-if="invoice.status === 1 || invoice.status === 2">
                Thêm sản phẩm vào giỏ hàng
            </button>

            <div class="table-responsive mt-4">
                <table class="table table-bordered table-hover table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Ảnh</th>
                            <th>Tên Sản Phẩm</th>
                            <th>Giá Bán</th>
                            <th>Số Lượng</th>
                            <th>Voucher</th>
                            <th>% Voucher</th>
                            <th>Tổng Tiền Sản Phẩm</th>
                            <td>Hành Động</td>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="cthd in invoicedetail">
                            <td>{{$index + 1}}</td>
                            <td>
                                <div class="image-container">
                                    <img ng-src="{{ cthd.productDetail.product.imageURL }}" alt="Product Image" />
                                </div>
                            </td>
                            <td>{{ cthd.productDetail.product.productName }} [{{ cthd.productDetail.color.colorName
                                }} - {{ cthd.productDetail.size.sizeNumber }}]</td>
                            <td>{{ cthd.productDetail.price | currency:'VND' }}</td>
                            <td>
                                <!-- Chỉ hiển thị input khi trạng thái hóa đơn là 1 hoặc 2 -->
                                <input type="number" class="form-control" ng-model="newQuantityFromUser"
                                    ng-change="updateProductQuantity(cthd, newQuantityFromUser)" min="1"
                                    max="{{ cthd.productDetail.quantity }}"
                                    ng-if="invoice.status === 1 || invoice.status === 2"
                                    ng-init="newQuantityFromUser = cthd.quantity || 1" />

                                <div ng-if="!(invoice.status === 1 || invoice.status === 2)">
                                    {{ cthd.quantity }}
                                </div>
                            </td>



                            <td>{{ cthd.invoice.voucher ? cthd.invoice.voucher.voucherCode : 'Không áp dụng' }}</td>
                            <td>{{ cthd.invoice.voucher ? cthd.invoice.voucher.discountPercentage + '(%)' : 'Không
                                áp dụng' }}</td>
                            <td>
                                {{ cthd.productDetail.price * cthd.quantity * (cthd.invoice.voucher ? (1 -
                                cthd.invoice.voucher.discountPercentage / 100) : 1) | currency:'VND' }}
                            </td>
                            <td>
                                <button ng-click="deleteProductFromInvoice(cthd)"
                                    ng-if="invoice.status === 1 || invoice.status === 2">
                                    Xóa sản phẩm
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>


            <!-- Modal chọn sản phẩm -->
            <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addProductModalLabel">Chọn Sản Phẩm</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Tìm kiếm và lọc -->
                            <div class="row mb-3">
                                <!-- Tìm kiếm sản phẩm -->
                                <div class="col-md-4">
                                    <input type="text" class="form-control" ng-model="searchQuery"
                                        placeholder="Tìm kiếm sản phẩm">
                                </div>
                            </div>

                            <!-- Bảng sản phẩm -->
                            <table class="table-light">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Ảnh</th>
                                        <th>Tên Sản Phẩm</th>
                                        <th>Số Lượng</th>
                                        <th>Giá</th>
                                        <th>Chọn</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Lặp qua sản phẩm có trạng thái là 1 và áp dụng lọc -->
                                    <tr
                                        ng-repeat="productdetail in filteredProductdetails = (availableProductdetails | filter:{ product: { brandId: selectedBrand, categoryId: selectedCategory } } | filter:searchQuery)">
                                        <td>{{$index + 1}}</td>
                                        <td>
                                            <div class="image-container">
                                                <img ng-src="{{ productdetail.product.imageURL }}"
                                                    alt="Product Image" />
                                            </div>
                                        </td>
                                        <td>{{ productdetail.product.productName }} [{{ productdetail.color.colorName }}
                                            - {{ productdetail.size.sizeNumber }}]</td>
                                        <td>
                                            <input type="number" class="form-control"
                                                ng-model="productdetail.selectedQuantity" min="1"
                                                max="{{ productdetail.quantity }}"
                                                ng-init="productdetail.selectedQuantity = 1" />
                                            <div>{{ productdetail.quantity }} có trong giỏ hàng</div>
                                        </td>
                                        <td>{{ productdetail.price | currency: 'VND' }}</td>
                                        <td>
                                            <button class="btn btn-primary"
                                                ng-click="addProductToInvoice(productdetail)">Thêm sản phẩm</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>





        </div>
    </div>
    </div>

    <script src="../assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/sidebarmenu.js"></script>
    <script src="../assets/js/app.min.js"></script>
    <script src="../assets/libs/apexcharts/dist/apexcharts.min.js"></script>
    <script src="../assets/libs/simplebar/dist/simplebar.js"></script>
    <script src="../assets/js/dashboard.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>


</body>

</html>